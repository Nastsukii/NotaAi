{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Cliente/Documents/GitHub/NotaAi/app/api/ai/route.ts"],"sourcesContent":["import { NextRequest } from 'next/server'\n\nexport async function POST(req: NextRequest) {\n  const body = await req.json()\n  const prompt = String(body?.prompt || '')\n  const files = Array.isArray(body?.files) ? body.files : []\n  if (!prompt) return new Response(JSON.stringify({ error: 'Missing prompt' }), { status: 400 })\n  const provider = process.env.AI_PROVIDER || 'openai'\n  const openaiKey = process.env.OPENAI_API_KEY\n  const geminiKey = process.env.GEMINI_API_KEY\n  if (provider === 'openai' && !openaiKey) return new Response(JSON.stringify({ error: 'Missing OPENAI_API_KEY' }), { status: 500 })\n  if (provider === 'gemini' && !geminiKey) return new Response(JSON.stringify({ error: 'Missing GEMINI_API_KEY' }), { status: 500 })\n\n  const parts: any[] = [{ type: 'text', text: prompt }]\n  for (const f of files) {\n    if (f?.mimeType?.startsWith('image/')) {\n      parts.push({ type: 'input_image', image_url: { url: `data:${f.mimeType};base64,${f.data}` } })\n    } else {\n      parts.push({ type: 'text', text: `Arquivo ${f?.mimeType || 'desconhecido'} anexado.` })\n    }\n  }\n\n  try {\n    console.log('[AI DEBUG] Request start', { provider, prompt_len: prompt.length, files_count: files.length })\n    if (provider === 'gemini') {\n      const contents = [\n        {\n          role: 'user',\n          parts: [\n            { text: prompt },\n            ...files.map((f: any) => ({ inlineData: { mimeType: f.mimeType, data: f.data } }))\n          ]\n        }\n      ]\n      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiKey}`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ contents, generationConfig: { responseMimeType: 'application/json' } })\n      })\n      if (!res.ok) {\n        const errText = await res.text()\n        console.error('[AI ERROR] Gemini response not OK', { status: res.status, statusText: res.statusText, body: errText })\n        return new Response(JSON.stringify({ error: 'Gemini error', status: res.status, details: errText }), { status: 500 })\n      }\n      const json = await res.json()\n      const textResponse = json?.candidates?.[0]?.content?.parts?.[0]?.text\n      const output = textResponse ? JSON.parse(textResponse) : json\n      console.log('[AI DEBUG] Gemini success', { has_output: Boolean(output) })\n      return new Response(JSON.stringify({ output }), { status: 200 })\n    } else {\n      const res = await fetch('https://api.openai.com/v1/chat/completions', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${openaiKey}`\n        },\n        body: JSON.stringify({\n          model: process.env.OPENAI_MODEL || 'gpt-4o-mini',\n          messages: [\n            { role: 'user', content: parts.map((p: any) => (\n              p.type === 'input_image'\n                ? { type: 'image_url', image_url: p.image_url }\n                : { type: 'text', text: p.text }\n            )) }\n          ],\n          response_format: { type: 'json_object' }\n        })\n      })\n      if (!res.ok) {\n        const errText = await res.text()\n        console.error('[AI ERROR] OpenAI response not OK', { status: res.status, statusText: res.statusText, body: errText })\n        return new Response(JSON.stringify({ error: 'OpenAI error', status: res.status, details: errText }), { status: 500 })\n      }\n      const json = await res.json()\n      const content = json?.choices?.[0]?.message?.content\n      const output = typeof content === 'string' ? JSON.parse(content) : content || json\n      console.log('[AI DEBUG] OpenAI success', { has_output: Boolean(output) })\n      return new Response(JSON.stringify({ output }), { status: 200 })\n    }\n  } catch (e: any) {\n    console.error('[AI ERROR] Exception thrown', { message: e?.message, stack: e?.stack })\n    return new Response(JSON.stringify({ error: e?.message || 'AI request failed' }), { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}